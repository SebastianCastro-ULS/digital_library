{% extends 'base.html' %}

{% block title %}Dashboard - {{ user.username }}{% endblock %}

{% block content %}
<h1>ğŸ‘¤ Dashboard de {{ user.full_name }}</h1>

<!-- EstadÃ­sticas principales -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
    <!-- Total libros leÃ­dos -->
    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
        <p style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">ğŸ“š Total LeÃ­dos</p>
        <p style="font-size: 42px; font-weight: bold; margin: 10px 0;">{{ total_read }}</p>
        <p style="font-size: 13px; opacity: 0.8;">libros completados</p>
    </div>
    
    <!-- Libros activos -->
    <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
        <p style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">ğŸ“– Prestados</p>
        <p style="font-size: 42px; font-weight: bold; margin: 10px 0;">{{ current_loans.count }}</p>
        <p style="font-size: 13px; opacity: 0.8;">libros activos</p>
    </div>
    
    <!-- CalificaciÃ³n promedio -->
    <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
        <p style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">â­ CalificaciÃ³n</p>
        <p style="font-size: 42px; font-weight: bold; margin: 10px 0;">
            {% if average_user_rating %}{{ average_user_rating|floatformat:1 }}{% else %}N/A{% endif %}
        </p>
        <p style="font-size: 13px; opacity: 0.8;">promedio personal</p>
    </div>
    
    <!-- Autor favorito -->
    <div style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
        <p style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">âœï¸ Autor Favorito</p>
        <p style="font-size: 20px; font-weight: bold; margin: 10px 0; line-height: 1.2;">
            {% if favorite_author %}{{ favorite_author }}{% else %}N/A{% endif %}
        </p>
        <p style="font-size: 13px; opacity: 0.8;">
            {% if favorite_author_count %}{{ favorite_author_count }} libros{% endif %}
        </p>
    </div>
</div>

<!-- BotÃ³n de recomendaciones destacado -->
<div style="background: white; padding: 20px; margin-bottom: 25px; border-radius: 10px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
    <h2 style="color: #333; margin-bottom: 10px;">ğŸ¯ Â¿Buscas tu prÃ³xima lectura?</h2>
    <p style="color: #666; margin-bottom: 15px;">BasÃ¡ndonos en tus {{ total_read }} libros leÃ­dos, tenemos recomendaciones personalizadas para ti</p>
    <a href="{% url 'user_recommendations' user.username %}" class="btn" style="font-size: 18px; padding: 12px 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none;">
        Ver Mis Recomendaciones ğŸš€
    </a>
</div>

<!-- InformaciÃ³n adicional -->
{% if favorite_publisher or most_read_year %}
<div style="background: white; padding: 20px; margin-bottom: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
    <h3 style="color: #333; margin-bottom: 15px;">ğŸ“Š MÃ¡s sobre tus lecturas</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
        {% if favorite_publisher %}
        <div style="background: #f8f9fa; padding: 15px; border-radius: 5px;">
            <p style="font-size: 13px; color: #666; margin-bottom: 5px;">ğŸ¢ Editorial Favorita</p>
            <p style="font-size: 18px; font-weight: bold; color: #333; margin: 0;">{{ favorite_publisher }}</p>
            <p style="font-size: 12px; color: #666; margin-top: 3px;">{{ favorite_publisher_count }} libros</p>
        </div>
        {% endif %}
        
        {% if most_read_year %}
        <div style="background: #f8f9fa; padding: 15px; border-radius: 5px;">
            <p style="font-size: 13px; color: #666; margin-bottom: 5px;">ğŸ“… AÃ±o MÃ¡s LeÃ­do</p>
            <p style="font-size: 18px; font-weight: bold; color: #333; margin: 0;">{{ most_read_year }}</p>
            <p style="font-size: 12px; color: #666; margin-top: 3px;">{{ most_read_year_count }} libros de ese aÃ±o</p>
        </div>
        {% endif %}
        
        {% if total_pages_read %}
        <div style="background: #f8f9fa; padding: 15px; border-radius: 5px;">
            <p style="font-size: 13px; color: #666; margin-bottom: 5px;">ğŸ“„ PÃ¡ginas LeÃ­das</p>
            <p style="font-size: 18px; font-weight: bold; color: #333; margin: 0;">{{ total_pages_read|floatformat:0 }}</p>
            <p style="font-size: 12px; color: #666; margin-top: 3px;">total aproximado</p>
        </div>
        {% endif %}
    </div>
</div>
{% endif %}

<!-- Libros prestados actualmente -->
<h2 style="margin-bottom: 15px;">ğŸ“š Libros Prestados Actualmente</h2>
<div class="book-grid">
    {% for loan in current_loans %}
    <div class="book-card">
        <h3>{{ loan.book.title }}</h3>
        <p><strong>Autor:</strong> {{ loan.book.authors }}</p>
        <p><strong>Editorial:</strong> {{ loan.book.publisher|default:"N/A" }}</p>
        
        <div style="background: #fff3cd; padding: 10px; border-radius: 5px; margin: 10px 0;">
            <p style="margin: 3px 0; font-size: 13px;"><strong>ğŸ“… Prestado:</strong> {{ loan.borrowed_date|date:"d/m/Y" }}</p>
            <p style="margin: 3px 0; font-size: 13px;"><strong>â° Vence:</strong> {{ loan.due_date|date:"d/m/Y" }}</p>
            
            {% now "Y-m-d" as today %}
            {% if loan.due_date|date:"Y-m-d" < today %}
            <p style="color: red; font-weight: bold; margin: 5px 0 0 0; font-size: 13px;">âš ï¸ Vencido</p>
            {% endif %}
        </div>
        
        <a href="{% url 'return_book' loan.book.book_id %}" class="btn btn-success" style="width: 100%;">Devolver Libro</a>
    </div>
    {% empty %}
    <div style="grid-column: 1/-1; text-align: center; padding: 40px; background: white; border-radius: 8px;">
        <p style="font-size: 48px; margin-bottom: 10px;">ğŸ“–</p>
        <p style="color: #666;">No tienes libros prestados actualmente.</p>
        <a href="{% url 'home' %}" class="btn" style="margin-top: 15px;">Buscar Libros</a>
    </div>
    {% endfor %}
</div>

<!-- Historial de lectura -->
<h2 style="margin-top: 40px; margin-bottom: 15px;">ğŸ“– Historial de Lectura</h2>

{% if reading_history %}
<!-- Filtros simples -->
<div style="background: white; padding: 15px; margin-bottom: 20px; border-radius: 8px;">
    <form method="GET" style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
        <select name="rating_filter" style="padding: 8px; border-radius: 5px; border: 1px solid #ddd;">
            <option value="">Todas las calificaciones</option>
            <option value="5">â­â­â­â­â­ (5.0)</option>
            <option value="4">â­â­â­â­ (4.0+)</option>
            <option value="3">â­â­â­ (3.0+)</option>
        </select>
        <button type="submit" class="btn" style="padding: 8px 20px;">Filtrar</button>
        <a href="{% url 'user_dashboard' user.username %}" style="padding: 8px 20px; background: #6c757d;" class="btn">Limpiar</a>
    </form>
</div>

<div class="book-grid">
    {% for loan in reading_history %}
    <div class="book-card">
        <h3>{{ loan.book.title }}</h3>
        <p><strong>Autor:</strong> {{ loan.book.authors }}</p>
        <p><strong>Editorial:</strong> {{ loan.book.publisher|default:"N/A" }}</p>
        <p style="font-size: 13px; color: #666;"><strong>ğŸ“… LeÃ­do:</strong> {{ loan.returned_date|date:"d/m/Y" }}</p>
        
        {% if loan.user_rating %}
        <div style="background: #d4edda; padding: 10px; border-radius: 5px; margin-top: 10px;">
            <p style="margin: 0;"><strong>Tu rating:</strong> â­ {{ loan.user_rating }}/5.0</p>
        </div>
        {% else %}
        <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin-top: 10px;">
            <p style="margin: 0; font-size: 13px; color: #666;">Sin calificaciÃ³n</p>
        </div>
        {% endif %}
    </div>
    {% endfor %}
</div>
{% else %}
<div style="text-align: center; padding: 40px; background: white; border-radius: 8px;">
    <p style="font-size: 48px; margin-bottom: 10px;">ğŸ“š</p>
    <p style="color: #666;">AÃºn no has completado ninguna lectura.</p>
    <p style="color: #999; font-size: 14px; margin-top: 5px;">Pide prestado un libro para empezar tu historial.</p>
</div>
{% endif %}

<style>
    .book-card {
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .book-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 20px rgba(0,0,0,0.15);
    }
</style>

{% endblock %}